{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load custom_filters %}
{% block content %}
<style>
    #edit_notes_section{
    display: none;
    margin-top: 1.5em;
}
    #submit_notes_btn{
    margin-top: 1.5em;
}
    .remove_icon{
    color: red;
    }
</style>
<div class="container report_heading" >
        <h2>{{report.name}}</h2>
        <h5>Date: {{ report.start_date }} - {{report.end_date}}</h5>
</div>
<div class="container report_section_heading" align="center">
        <hr>
        <div>
                Ruleset
        </div>


</div>
<div class="container report_section" id="ruleset_section" align="center">
        {% if report.ruleset %}
                <h3>
                    <a href="{% url 'budgets:single_ruleset' pk=report.ruleset.id %}">{{report.ruleset.name}}</a>
                </h3>
                <p><a id="change_ruleset_btn" href="{% url 'reports:add_ruleset' pk=report.id %}">Change Ruleset</a></p>
        {% else %}
                <a id="add_ruleset_btn" href="{% url 'reports:add_ruleset' pk=report.id %}" role="button" class="btn btn-outline-secondary w-80">Add Ruleset</a>
        {% endif %}

</div>
<div class="container report_section_heading" align="center">
        <hr>
        <div>
                Budget
        </div>


</div>
<div class="container report_section" id="budget_section" align="center">
        {% if report.budget %}
            <h3>
                <a href="{% url 'budgets:single_budget' pk=report.budget.id %}">{{report.budget.name}}</a>
            </h3>
            <p><a id="chnage_budget_btn" href="{% url 'reports:add_budget' pk=report.id %}">Change Budget</a></p>
        {% else %}
                <a id="add_budget_btn" href="{% url 'reports:add_budget' pk=report.id %}" role="button" class="btn btn-outline-secondary w-80">Add Budget</a>
        {% endif %}


</div>
<div class="container report_section_heading" align="center">
        <hr>
        <div onclick="showSection('transactions_section')">
                All Transactions
                <i class="bi-caret-right-fill sub-caret" id="transactions_section_caret" ></i>
        </div>


</div>
<div class="container report_section" id="transactions_section" align="center" style="display: none;">
        <div style="padding-bottom: 10px;">
            {% if report.ruleset %}
                <a href="{% url 'reports:add_transaction' pk=report.id %}" role="button" class="btn btn-outline-secondary w-80">Add Transaction</a>
                {% if report.transaction_sheet %}
                    <a href="{% url 'reports:add_transactions' pk=report.id %}" role="button" class="btn btn-outline-secondary w-80">Import from Transactions Sheet</a>
                {% else %}
                    <span class="text-muted">No transaction sheet uploaded</span>
                {% endif %}
                <a href="{% url 'reports:import_from_account' pk=report.id %}" role="button" class="btn btn-outline-primary w-80">
                    <i class="bi bi-bank"></i> Import from Bank Account
                </a>
                <a href="{% url 'reports:clear_transactions' pk=report.id %}" role="button" class="btn btn-outline-secondary w-80">Clear Transactions</a>
            {% else %}
                <span class="text-danger">No transactions imported. Add ruleset to proceed.</span>
            {% endif %}
        </div>
    {% if report.transaction_set.all %}
        <div style="padding-bottom: 15px;">
            <label for="all_transactions_category_filter" style="margin-right: 10px;">Filter by Category:</label>
            <select id="all_transactions_category_filter" class="form-select" style="width: auto; display: inline-block;">
                <option value="">All Categories</option>
                {% for category in all_categories %}
                    <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
        </div>
          <table class="table table-striped" id="all_transactions_table">
               <thead class="table-dark">
                    <tr>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('all_transactions_table', 0, 'date')">
                            Date <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('all_transactions_table', 1, 'text')">
                            Name <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th scope="col">Category</th>
                        <th scope="col" style="cursor: pointer;" onclick="sortTable('all_transactions_table', 3, 'number')">
                            Amount <i class="bi bi-arrow-down-up"></i>
                        </th>
                        <th scope="col"></th>
                    </tr>
               </thead>
               <tbody>
                        {% for transaction in report.transaction_set.all %}
                               <tr data-category="{{ transaction.category }}">
                                <td>{{ transaction.date}} </td>
                                <td>{{ transaction.name}} </td>
                                <td>{{ transaction.category}} </td>
                                {% if transaction.is_expense %}
                                   <td class="expense_transaction">{{ transaction.amount}} </td>
                                {% else %}
                                   <td class="earning_transaction">{{ transaction.amount}} </td>
                                {% endif %}
                               <td>
                                   <a href="{% url 'reports:edit_transaction' pk=transaction.id %}"><i class="bi bi-pencil-square"></i></a>
                                   <a href="{% url 'reports:delete_transaction' pk=transaction.id %}"><i class="bi bi-x-square-fill remove_icon"></i></a>
                               </td>
                              </tr>
                        {% endfor %}
               </tbody>
          </table>
             <hr>
    {% endif %}
</div>
{% if report.transaction_set.all %}
        <div class="container expenses_section_heading report_section_heading" align="center">
            <hr>
            <div onclick="showSection('expenses_section')">
                    Expenses
                    <i class="bi-caret-right-fill sub-caret" id="expenses_section_caret" ></i>
            </div>
        </div>
    <div class="container report_section" id="expenses_section" align="center" style="display: none;">
            <div style="padding-bottom: 10px;">
            </div>
                <h3>Total Expenses: ${{ expenses_total }}</h3><br><br>
                <h5>Top categories</h5>
                <div class="container report_section" id="expenses_chart_section" align="center">
                     <canvas id="expensesPieChart" style="display: none; box-sizing: border-box; height: 600px; width: 600px;"></canvas>
                </div><br><br>
                <div style="padding-bottom: 15px;">
                    <label for="expenses_category_filter" style="margin-right: 10px;">Filter by Category:</label>
                    <select id="expenses_category_filter" class="form-select" style="width: auto; display: inline-block;">
                        <option value="">All Categories</option>
                        {% for category in expense_categories %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
              <table class="table table-striped" id="expenses_table">
                   <thead class="table-dark">
                        <tr>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('expenses_table', 0, 'date')">
                                Date <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('expenses_table', 1, 'text')">
                                Name <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th scope="col">Category</th>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('expenses_table', 3, 'number')">
                                Amount <i class="bi bi-arrow-down-up"></i>
                            </th>
                        </tr>
                   </thead>
                   <tbody>
                            {% for transaction in expenses %}
                                   <tr data-category="{{ transaction.category }}">
                                    <td>{{ transaction.date}} </td>
                                    <td>{{ transaction.name}} </td>
                                    <td>{{ transaction.category}} </td>
                                    <td class="expense_transaction">{{ transaction.amount}} </td>
                                  </tr>
                            {% endfor %}

                   </tbody>
              </table>
              <hr>

    </div>
     <div class="container earnings_section_heading report_section_heading" align="center">
            <hr>
            <div onclick="showSection('earnings_section')">
                    Earnings
                    <i class="bi-caret-right-fill sub-caret" id="earnings_section_caret" ></i>
            </div>
        </div>
    <div class="container report_section" id="earnings_section" align="center" style="display: none;">
            <div style="padding-bottom: 10px;">
            </div>
                <h3>Total Earnings: ${{ earnings_total }}</h3><br><br>

                <h5>Top categories</h5>
                <div class="container report_section" id="earnings_chart_section" align="center"
                    style="display: none; box-sizing: border-box; height: 600px; width: 600px;">
                     <canvas id="earningsPieChart" width="150" height="50"></canvas>
                </div><br><br>
                <div style="padding-bottom: 15px;">
                    <label for="earnings_category_filter" style="margin-right: 10px;">Filter by Category:</label>
                    <select id="earnings_category_filter" class="form-select" style="width: auto; display: inline-block;">
                        <option value="">All Categories</option>
                        {% for category in earning_categories %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
              <table class="table table-striped" id="earnings_table">
                   <thead class="table-dark">
                        <tr>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('earnings_table', 0, 'date')">
                                Date <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('earnings_table', 1, 'text')">
                                Name <i class="bi bi-arrow-down-up"></i>
                            </th>
                            <th scope="col">Category</th>
                            <th scope="col" style="cursor: pointer;" onclick="sortTable('earnings_table', 3, 'number')">
                                Amount <i class="bi bi-arrow-down-up"></i>
                            </th>
                        </tr>
                   </thead>
                   <tbody>
                            {% for transaction in earnings %}
                                   <tr data-category="{{ transaction.category }}">
                                    <td>{{ transaction.date}} </td>
                                    <td>{{ transaction.name}} </td>
                                    <td>{{ transaction.category}} </td>
                                    <td class="earning_transaction">{{ transaction.amount}} </td>
                                  </tr>
                            {% endfor %}
                   </tbody>
              </table>
              <hr>
    </div>
    {% if report.budget %}
        <div class="container budvact_section report_section_heading" align="center">
            <hr>
            <div onclick="showSection('comparison_section')">
                    Budget  vs Actual
                    <i class="bi-caret-right-fill sub-caret" id="comparison_section_caret" ></i>
            </div>
        </div>
        <div class="container report_section" id="comparison_section" align="center" style="display: none;">
          <table class="table table-striped">
               <thead class="table-dark">
                    <tr>
                        <th scope="col">Earning </th>
                        <th scope="col">Budget</th>
                        <th scope="col">Actual</th>
                        <th scope="col">Difference</th>
                    </tr>
               </thead>
               <tbody>
                        {% for budget_category in report.budget.budgetcategory_set.all  %}
                            {% with diff=earning_differences|get:budget_category.category.title %}
                              {% if budget_category.is_earning %}
                               <tr>
                                <td>{{ budget_category.category }} </td>
                                <td>{{ budget_category.limit }} </td>
                                <td>{{ total_earning_by_category|default_if_none:"0"|get:budget_category.category.title|default:"0"|floatformat:2 }}</td>
                                {% if diff < 0 %}
                                    <td class="expense_transaction">{{ diff|default:"0"|floatformat:2 }}</td>
                                {% else %}
                                    <td class="earning_transaction">{{ diff|default:"0"|floatformat:2 }}</td>
                                {% endif %}
                              </tr>
                              {% endif %}
                            {% endwith %}
                        {% endfor %}
                            <tr class="table-dark">
                                <td>Total Earnings</td>
                                <td>{{ budget_category_earnings_total|default:"0"|floatformat:2 }} </td>
                                <td>{{ total_earnings_by_budget|default:"0"|floatformat:2 }}</td>
                                {% if total_earnings_difference < 0 %}
                                    <td class="expense_transaction">{{ total_earnings_difference|default:"0"|floatformat:2 }}</td>
                                {% else %}
                                    <td class="earning_transaction">{{ total_earnings_difference|default:"0"|floatformat:2 }}</td>
                                {% endif %}
                            </tr>
               </tbody>
          </table>

          <table class="table table-striped">
               <thead class="table-dark">
                    <tr>
                        <th scope="col">Expense </th>
                        <th scope="col">Budget</th>
                        <th scope="col">Actual</th>
                        <th scope="col">Difference</th>
                    </tr>
               </thead>
               <tbody>
                        {% for budget_category in report.budget.budgetcategory_set.all  %}
                            {% with diff=expense_differences|get:budget_category.category.title %}
                              {% if not budget_category.is_earning %}
                               <tr>
                                <td>{{ budget_category.category }} </td>
                                <td>{{ budget_category.limit }} </td>
                                <td>{{ total_expense_by_category|default_if_none:"0"|get:budget_category.category.title|default:"0"|floatformat:2 }}</td>
                                {% if diff < 0 %}
                                    <td class="expense_transaction">{{ diff|default:"0"|floatformat:2 }}</td>
                                {% else %}
                                    <td class="earning_transaction">{{ diff|default:"0"|floatformat:2 }}</td>
                                {% endif %}
                              </tr>
                              {% endif %}
                            {% endwith %}
                        {% endfor %}
                            <tr class="table-dark">
                                <td>Total Expenses </td>
                                <td>{{ budget_category_expenses_total|default:"0"|floatformat:2 }} </td>
                                <td>{{ total_expenses_by_budget|default:"0"|floatformat:2 }}</td>
                                {% if total_expenses_difference < 0 %}
                                    <td class="expense_transaction">{{ total_expenses_difference|default:"0"|floatformat:2 }}</td>
                                {% else %}
                                    <td class="earning_transaction">{{ total_expenses_difference|default:"0"|floatformat:2 }}</td>
                                {% endif %}
                            </tr>
               </tbody>
          </table>
          <hr>
        </div>
    {% endif %}
{% endif %}

<div class="container notes_section report_section_heading" align="center">
            <hr>
            <div onclick="showSection('notes_section')">
                    Notes
                    <i class="bi-caret-right-fill sub-caret" id="notes_section_caret" ></i>
            </div>
</div>
<div class="container report_section" id="notes_section" align="center" style="display: none;">
        <p class="lead" id="report_notes">{{ report.notes }}</p>
        <button class="btn btn-outline-primary" id="edit_notes_btn">Edit</button>

    <div id="edit_notes_section">
        <textarea class="form-control" id="notes_input">{{ report.notes }}</textarea>
        <button class="btn btn-outline-primary" id="submit_notes_btn">Submit</button>
    </div>
</div>


<div id="report_controls" class="container" align="center">
        <br><br>
        <a href="{% url 'reports:update_report' pk=report.id %}" role="button" class="btn btn-outline-secondary  w-80">Edit Report</a>
        <a href="{% url 'reports:generate_pdf' pk=report.id %}" role="button" class="btn btn-outline-secondary  w-80">Generate PDF</a>
        {% if report.is_archived %}
            <a href="{% url 'reports:toggle_archive' pk=report.id %}" role="button" class="btn btn-outline-info  w-80">Unarchive Report</a>
        {% else %}
            <a href="{% url 'reports:toggle_archive' pk=report.id %}" role="button" class="btn btn-outline-warning  w-80">Archive Report</a>
        {% endif %}
        <a href="{% url 'reports:delete_report' pk=report.id %}" role="button" class="btn btn-outline-danger  w-80">Delete Report</a>
</div><br><br>







<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $('#edit_notes_btn').click(function() {
                $('#report_notes, #edit_notes_btn').hide();
                $('#edit_notes_section').show();
           });

        $(document).ready(function() {
            $('#submit_notes_btn').click(function() {
                var notes = $('#notes_input').val();
                var reportId = {{ report.id }};

                $.ajax({
                    url: "/reports/report/" + reportId + "/add_notes",
                    type: 'POST',
                    data: {
                        'notes': notes,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#report_notes').text(response.notes);
                            $('#report_notes, #edit_notes_btn').show();
                            $('#edit_notes_section').hide();
                        } else {
                            alert('Failed to update notes');
                        }
                    },
                    error: function() {
                        alert('An error occurred');
                    }
                });
            });
        });
    </script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('expensesPieChart').getContext('2d');

        // Load the JSON data from the context
        const expensesData = JSON.parse('{{ expenses_by_category|safe }}');

        let labels = [];
        let data = [];
        expensesData.forEach(item => {
            labels.push(item.category__title);
            data.push(parseFloat(item.total_amount));  // Ensure the data is parsed as a float
        });

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Expenses by Category',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const amount = parseFloat(context.raw) || 0;
                                return `${label}: $${amount.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('earningsPieChart').getContext('2d');

        // Load the JSON data from the context
        const earningsData = JSON.parse('{{ earnings_by_category|safe }}');

        let labels = [];
        let data = [];
        earningsData.forEach(item => {
            labels.push(item.category__title);
            data.push(parseFloat(item.total_amount));  // Ensure the data is parsed as a float
        });

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Earnings by Category',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const amount = parseFloat(context.raw) || 0;
                                return `${label}: $${amount.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
<script>
        function showSection(section_id) {
            const section = document.getElementById(section_id);
            var section_caret = document.getElementById(section_id + "_caret");
              if (section_caret.classList.contains("bi-caret-right-fill")) {
                section_caret.classList.add("bi-caret-down-fill");
                section_caret.classList.remove("bi-caret-right-fill");

              }
              else{
                section_caret.classList.remove("bi-caret-down-fill");
                section_caret.classList.add("bi-caret-right-fill");
              }

              if(section.style.display === 'none'){
                section.style.display='block';
              }
              else{
                section.style.display='none';
              }
        }

        // Category filtering functionality
        function filterTable(tableId, filterValue) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const category = rows[i].getAttribute('data-category');

                if (filterValue === '' || category === filterValue) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        // Table sorting functionality
        let sortDirections = {};

        function sortTable(tableId, columnIndex, dataType) {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));

            // Initialize sort direction for this table-column combination
            const sortKey = tableId + '-' + columnIndex;
            if (!sortDirections[sortKey]) {
                sortDirections[sortKey] = 'asc';
            }

            // Toggle sort direction
            const isAscending = sortDirections[sortKey] === 'asc';
            sortDirections[sortKey] = isAscending ? 'desc' : 'asc';

            // Sort rows based on data type
            rows.sort((a, b) => {
                let aValue = a.getElementsByTagName('td')[columnIndex].textContent.trim();
                let bValue = b.getElementsByTagName('td')[columnIndex].textContent.trim();

                if (dataType === 'date') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else if (dataType === 'number') {
                    aValue = parseFloat(aValue.replace(/[^0-9.-]/g, '')) || 0;
                    bValue = parseFloat(bValue.replace(/[^0-9.-]/g, '')) || 0;
                } else {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Event listeners for category filters
        document.addEventListener('DOMContentLoaded', function() {
            const allTransactionsFilter = document.getElementById('all_transactions_category_filter');
            const expensesFilter = document.getElementById('expenses_category_filter');
            const earningsFilter = document.getElementById('earnings_category_filter');

            if (allTransactionsFilter) {
                allTransactionsFilter.addEventListener('change', function() {
                    filterTable('all_transactions_table', this.value);
                });
            }

            if (expensesFilter) {
                expensesFilter.addEventListener('change', function() {
                    filterTable('expenses_table', this.value);
                });
            }

            if (earningsFilter) {
                earningsFilter.addEventListener('change', function() {
                    filterTable('earnings_table', this.value);
                });
            }
        });
    </script>

{% endblock %}
