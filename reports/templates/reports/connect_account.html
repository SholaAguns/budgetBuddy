{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
<div class="container">
    <h2>Connect Bank Account</h2>
    <p class="text-muted">Select your bank to connect your account</p>

    <div class="mb-3">
        <label for="country_select">Country:</label>
        <select id="country_select" class="form-select" style="width: auto;" onchange="changeCountry(this.value)">
            <option value="GB" {% if country_code == 'GB' %}selected{% endif %}>United Kingdom</option>
            <option value="IE" {% if country_code == 'IE' %}selected{% endif %}>Ireland</option>
            <option value="DE" {% if country_code == 'DE' %}selected{% endif %}>Germany</option>
            <option value="FR" {% if country_code == 'FR' %}selected{% endif %}>France</option>
            <option value="ES" {% if country_code == 'ES' %}selected{% endif %}>Spain</option>
            <option value="IT" {% if country_code == 'IT' %}selected{% endif %}>Italy</option>
            <option value="NL" {% if country_code == 'NL' %}selected{% endif %}>Netherlands</option>
        </select>
    </div>

    <div class="mb-3">
        <input type="text" id="search_bank" class="form-control" placeholder="Search for your bank..." onkeyup="filterBanks()">
    </div>

    <form method="post">
        {% csrf_token %}
        <div class="mb-3">
            <label for="account_name">Account Name (optional):</label>
            <input type="text" name="account_name" id="account_name" class="form-control" placeholder="e.g., My Checking Account">
        </div>

        <div class="list-group" id="bank_list">
            {% for institution in institutions %}
            <label class="list-group-item bank-item" data-name="{{ institution.name|lower }}">
                <input type="radio" name="institution_id" value="{{ institution.id }}" required>
                <div class="d-flex align-items-center">
                    {% if institution.logo %}
                    <img src="{{ institution.logo }}" alt="{{ institution.name }}" style="width: 40px; height: 40px; margin-right: 15px;">
                    {% endif %}
                    <div>
                        <strong>{{ institution.name }}</strong>
                        {% if institution.bic %}
                        <br><small class="text-muted">BIC: {{ institution.bic }}</small>
                        {% endif %}
                    </div>
                </div>
            </label>
            {% endfor %}
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Connect Account</button>
            <a href="{% url 'reports:account_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    function changeCountry(country) {
        window.location.href = '{% url "reports:connect_account" %}?country=' + country;
    }

    function filterBanks() {
        const input = document.getElementById('search_bank');
        const filter = input.value.toLowerCase();
        const bankItems = document.querySelectorAll('.bank-item');

        bankItems.forEach(item => {
            const bankName = item.getAttribute('data-name');
            if (bankName.includes(filter)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
